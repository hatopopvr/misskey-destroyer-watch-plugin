/// @ 0.13.3
### {
  name: "通知からリアクション等を一覧で表示するプラグイン",
  version: "0.2.1",
  author: "はとぽぷ",
  description: "直近100件の通知のリアクションとリノートを取得",
  permissions: ["read:notifications"],
  config: {
    notificationLimit: {
      type: "number",
      label: "通知の取得数",
      description: "APIの制限により最大100です。",
      default: 100
    },
    serverName: {
      type: "string",
      label: "所属するサーバー名",
      default: "misskey.io"
    },
    usernameSuffixText: {
      type: "string",
      label: "ユーザー名の語尾につけるテキスト",
      default: ":tyan:"
    },
    reactionIsEnable: {
      type: "boolean",
      label: "リアクションを取得する",
      default: true
    },
    renoteIsEnable: {
      type: "boolean",
      label: "リノートを取得する",
      description: "引用リノートは含みません。",
      default: true
    },
    linkIsEnable: {
      type: "boolean",
      label: "リアクションやリノートに元ノートのリンクを付与",
      default: true
    },
    reactionReverse: {
      type: "boolean",
      label: "リアクションの表示順を反転",
      default: true
    },
    dialogReactionVisible: {
      type: "boolean",
      label: "ダイアログのリアクション詳細表示",
      default: true
    },
    dialogReactionCountVisible: {
      type: "boolean",
      label: "ダイアログのリアクション数表示",
      default: true
    },
    dialogDestroyerLimit: {
      type: "number",
      label: "ダイアログの最大ユーザー数",
      default: 20
    },
    dialogReactionMin: {
      type: "number",
      label: "ダイアログに表示する最低リアクション数",
      default: 1
    },
    dialogHeaderText: {
      type: "string",
      label: "ダイアログのヘッダーテキスト",
      default: "<center>$[twitch.speed=0.5s $[rainbow.speed=3s $[flip :murakamisan_tutinoko_omae_wo_miteiru:]:omae_wo_miteiru2::tuuti_hakai::role_notification_destroyer::tuuti_hakai::omae_wo_miteiru2::murakamisan_tutinoko_omae_wo_miteiru:]]</center>"
    },
    dialogUserPrefixText: {
      type: "string",
      label: "ダイアログのユーザー接頭辞テキスト",
      default: ":ai_panic_misskeyio:"
    },
    dialogReactionSeparator: {
      type: "string",
      label: "ダイアログのReaction間セパレータ",
      default: ""
    },
    resultReactionVisible: {
      type: "boolean",
      label: "投稿用テキストのリアクション詳細表示",
      default: true
    },
    resultReactionCountVisible: {
      type: "boolean",
      label: "投稿用テキストのリアクション数表示",
      default: true
    },
    resultDestroyerLimit: {
      type: "number",
      label: "投稿用テキストの最大ユーザー数",
      default: 3
    },
    resultReactionMin: {
      type: "number",
      label: "投稿用テキストに表示する最低リアクション数",
      default: 1
    },
    resultHeaderText: {
      type: "string",
      label: "投稿用テキストのヘッダーテキスト",
      default: ":role_notification_destroyer::murakamisan_tutinoko_omae_wo_miteiru:"
    },
    resultUserSuffixText: {
      type: "string",
      label: "投稿用テキストのユーザー末尾テキスト",
      default: ":arigatofes:$[flip :meowpensivepray:]"
    },
    resultReactionSeparator: {
      type: "string",
      label: "投稿用テキストでのReaction間セパレータ",
      default: ""
    },
    resultFooterTagText: {
      type: "string",
      label: "投稿用テキストのフッターに追加するタグテキスト",
      default: "#MisskeyDestroyerWatch"
    }
  }
}
// configに値がない場合デフォルト値を取得
@getConfigValue(configValue, defaultValue) {
    if (configValue != null) {
        configValue
    } else {
        defaultValue
    }
}

// APIからの通知を取得
@getNotifications(limit) {
    let result = Mk:api("i/notifications", {limit: limit})
    result
}

// ユーザーとリアクションを集計
@aggregateUserReactions(notifications, config) {
    // ユーザーとリアクションを保存するためのオブジェクト
    let userReactionCount = {}
    let userIdList = []

    each (let notif notifications) {
        // リアクションを取得
        if (config.reactionIsEnable == true && notif.type == 'reaction') {
            let userId = notif.user.id
            let userName = notif.user.name
            let noteId = notif.note.id
            var reaction = `{notif.reaction}`

            // userのリストの追加
            if (!userIdList.incl(userId)) {
                userIdList.push(userId)
            }

            // userReactionCountにuserIdがなければ初期化
            if (Obj:has(userReactionCount, userId) == false) {
                Obj:set(userReactionCount, userId, { user: notif.user, reactions: [] })
            }

            //リアクションを取得
            if (config.linkIsEnable == true) {
                reaction = `?[{notif.reaction}](https://{config.serverName}/notes/{noteId})`
            }

            let userReactions = Obj:get(Obj:get(userReactionCount, userId), 'reactions')

            // リアクションをユーザーに追加
            userReactions.push(reaction)
        }

        // リノートを取得
        if (config.renoteIsEnable == true && notif.type == 'renote') {
            let userId = notif.user.id
            let userName = notif.user.name
            let noteId = notif.note.id
            var reaction = `:rn:`

            // userのリストの追加
            if (!userIdList.incl(userId)) {
                userIdList.push(userId)
            }

            // userReactionCountにuserIdがなければ初期化
            if (Obj:has(userReactionCount, userId) == false) {
                Obj:set(userReactionCount, userId, { user: notif.user, reactions: [] })
            }

            //リノートを取得
            if (config.linkIsEnable == true) {
                reaction = `?[:rn:](https://{config.serverName}/notes/{noteId})`
            }

            let userReactions = Obj:get(Obj:get(userReactionCount, userId), 'reactions')

            // リアクションをユーザーに追加
            userReactions.push(reaction)
        }
    }

    // countListに各リアクション数の追加
    let countList = []
    each (let userId userIdList){
        let userReactions = Obj:get(Obj:get(userReactionCount, userId), 'reactions')
        countList.push(userReactions.len)
    }

    let resultObj = {}
    Obj:set(resultObj, "userReactionCount", userReactionCount)
    Obj:set(resultObj, "userIdList", userIdList)
    Obj:set(resultObj, "countList", countList)
    resultObj
}

// indexに基づいてソート
@sortByIndices(sortedIndices, targetList) {
    let sortedList = []
    each (let i sortedIndices) {
        sortedList.push(targetList[i])
    }
    sortedList
}

// ソート処理
@sortUsersByReaction(userIdList, countList) {
    let sortedIndices = []
    for (let i, countList.len) {
        sortedIndices.push(i)
    }

    sortedIndices.sort(@(a, b) {
        return countList[b] - countList[a]
    })

    let sortedUserIdList = sortByIndices(sortedIndices, userIdList)
    let sortedCountList = sortByIndices(sortedIndices, countList)

    let sortedObj = {}
    Obj:set(sortedObj, "sortedUserIdList", sortedUserIdList)
    Obj:set(sortedObj, "sortedCountList", sortedCountList)
    sortedObj
}

@createUserTextLists(sortedUserIdList, userReactionCount, overrideResultText, config) {
    // -----------------------------------------------------------------
    var resultText = "通知破壊などありません"
    // 注記。
    var dialogCautionText = "<center><small>※このプラグインは直近最大100件の通知を取得するものです。ユーザーのページへの遷移はユーザー名右クリックで新しいタブを開くなどで飛んでください。</small></center>"
    // -----------------------------------------------------------------

    // ダイアログと投稿用テキストの作成
    let dialogTextList = []
    let resultTextList = []
    var destroyerCount = 0
    dialogTextList.push(config.dialogHeaderText)
    dialogTextList.push(dialogCautionText)
    resultTextList.push(config.resultHeaderText)

    each (let userId sortedUserIdList){
        let user = Obj:get(Obj:get(userReactionCount, userId), 'user')
        let userReactions = Obj:get(Obj:get(userReactionCount, userId), 'reactions')

        if (config.reactionReverse == true) {
            userReactions.reverse()
        }

        var dialogReactionCountText = userReactions.len
        if (config.dialogReactionCountVisible == false) {
            dialogReactionCountText = ""
        }

        var resultReactionCountText = userReactions.len
        if (config.resultReactionCountVisible == false) {
            resultReactionCountText = ""
        }

        if (config.dialogDestroyerLimit > destroyerCount && userReactions.len >= config.dialogReactionMin) {
            let dialogUserReactions = userReactions.join(`{config.dialogReactionSeparator}`)
            if (config.dialogReactionVisible == false) {
                dialogUserReactions = ""
            }
            dialogTextList.push(`{config.dialogUserPrefixText}@{user.username}:tyan: {dialogReactionCountText} {dialogUserReactions}`)
        }
        if (config.resultDestroyerLimit > destroyerCount && userReactions.len >= config.dialogReactionMin) {
            let resultUserReactions = userReactions.join(`{config.resultReactionSeparator}`)
            if (config.resultReactionVisible == false) {
                resultUserReactions = ""
            }
            resultTextList.push(`@{user.username}:tyan: {resultReactionCountText} {config.resultUserSuffixText}{Str:lf}{resultUserReactions}{Str:lf}`)
        }
        destroyerCount = destroyerCount + 1
    }

    resultTextList.push(`{config.resultFooterTagText}`)

    // 結合
    let dialogText = dialogTextList.join(Str:lf)
    if (overrideResultText == true) {
        resultText = resultTextList.join(Str:lf)
    } else {
        resultText = overrideResultText
    }
    let resultTextObj = {}
    Obj:set(resultTextObj, "dialogText", dialogText)
    Obj:set(resultTextObj, "resultText", resultText)
    resultTextObj
}

@misskeyDestroyerWatch(overrideResultText) {
    // 設定を取得
    let config = Plugin:config
    // 通知の取得数です。APIの制限により現在は最大100です。
    var notificationLimit = getConfigValue(config.notificationLimit, 100)
    // Misskey APIから通知の取得
    let notifications = getNotifications(notificationLimit)

    // ユーザーとリアクションを保存するためのオブジェクト
    let userReactionObj = aggregateUserReactions(notifications, config)
    let userReactionCount = Obj:get(userReactionObj, "userReactionCount")
    let userIdList = Obj:get(userReactionObj, "userIdList")
    let countList = Obj:get(userReactionObj, "countList")

    // リアクション数順にソートしたオブジェクト
    let sortedObj = sortUsersByReaction(userIdList, countList)
    let sortedUserIdList = Obj:get(sortedObj, "sortedUserIdList")

    // ダイアログと投稿用テキストの作成
    let resultTextObj = createUserTextLists(sortedUserIdList, userReactionCount, overrideResultText, config)
    let dialogText = Obj:get(resultTextObj, "dialogText")
    let resultText = Obj:get(resultTextObj, "resultText")

    // ダイアログに表示
    Mk:dialog(null dialogText)
resultText}

Plugin:register_post_form_action(`[投稿]直近100件の通知を取得！` @(f u) {u("text" misskeyDestroyerWatch(true))})
Plugin:register_post_form_action(`[閲覧]直近100件の通知を取得！` @(f u) {u("text" misskeyDestroyerWatch(f.text))})